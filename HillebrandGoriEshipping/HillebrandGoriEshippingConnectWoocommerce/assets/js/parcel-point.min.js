"use strict";
var _typeof =
    "function" == typeof Symbol && "symbol" == typeof Symbol.iterator
      ? function (e) {
          return typeof e;
        }
      : function (e) {
          return e &&
            "function" == typeof Symbol &&
            e.constructor === Symbol &&
            e !== Symbol.prototype
            ? "symbol"
            : typeof e;
        },
  _slicedToArray = (function () {
    return function (e, t) {
      if (Array.isArray(e)) return e;
      if (Symbol.iterator in Object(e))
        return (function (e, t) {
          var n = [],
            a = !0,
            r = !1,
            o = undefined;
          try {
            for (
              var i, c = e[Symbol.iterator]();
              !(a = (i = c.next()).done) &&
              (n.push(i.value), !t || n.length !== t);
              a = !0
            );
          } catch (s) {
            (r = !0), (o = s);
          } finally {
            try {
              !a && c["return"] && c["return"]();
            } finally {
              if (r) throw o;
            }
          }
          return n;
        })(e, t);
      throw new TypeError(
        "Invalid attempt to destructure non-iterable instance"
      );
    };
  })();
!(function () {
  var e = {};
  let APIkey =
    "pk.eyJ1Ijoic2Fmb2luZTI3IiwiYSI6ImNrZ3FnaHFrMzAzemoyem83eDEwNHByNGgifQ.r6hMjCHYAfeeLJdftc-39Q";
  (e.parcelPointLinks = {
    trigger: ".VINW-select-parcel",
    mapContainer: null,
    map: null,
    markers: [],
    initMap: function () {
      var e = this,
        t = document.createElement("div");
      t.setAttribute("class", "VINW-close"),
        t.setAttribute("title", translations.text.closeMap),
        t.addEventListener("click", function () {
          e.closeMap();
        });
      var n = document.createElement("div");
      n.setAttribute("id", "VINW-map-canvas");
      var a = document.createElement("div");
      a.setAttribute("id", "VINW-map-container"), a.appendChild(n);
      var r = document.createElement("div");
      r.setAttribute("id", "VINW-pp-container");
      var o = document.createElement("div");
      mapboxgl.accessToken = APIkey;
      o.setAttribute("id", "VINW-map-inner"),
        o.appendChild(t),
        o.appendChild(a),
        o.appendChild(r),
        (e.mapContainer = document.createElement("div")),
        e.mapContainer.setAttribute("id", "VINW-map"),
        e.mapContainer.appendChild(o),
        document.body.appendChild(e.mapContainer),
        (e.map = new mapboxgl.Map({
          container: "VINW-map-canvas",
          style: "mapbox://styles/mapbox/streets-v9",
          zoom: 15,
        })),
        e.map.addControl(new mapboxgl.NavigationControl());

      var i = document.createElement("img");
      i.setAttribute(
        "src",
        `${baseurl}/wp-content/plugins/HillebrandGoriEshipping/HillebrandGoriEshipping/HillebrandGoriEshippingConnectWoocommerce/assets/img/e-shipping.png`
      );

      var s = document.createElement("div");
      s.setAttribute("id", "VINW-Vignoblexport-logo"), s.appendChild(i);
      var l = document.querySelector(".mapboxgl-ctrl-top-left");
      l && l.appendChild(s);
    },
    init: function () {
      var e = this;
      e.on("body", "click", e.trigger, function () {
        if (jQuery("#billing_address_1").val() == "") {
          alert("Please fill the street input");
        } else if (jQuery("#billing_city").val() == "") {
          alert("Please fill the city input below");
        } else if (jQuery("#billing_postcode").val() == "") {
          alert("Please fill the zip code input below");
        } else {
          (e.mapContainer = document.querySelector("#VINW-map")),
            e.mapContainer || e.initMap(),
            e.openMap(),
            e.getPoints();
        }
      }),
        e.on("body", "click", ".VINW-parcel-point-button", function () {
          e.selectPoint(
            this.getAttribute("data-code"),
            unescape(this.getAttribute("data-name")),
            this.getAttribute("data-network"),
            unescape(this.getAttribute("data-street")),
            unescape(this.getAttribute("data-zipcode")),
            unescape(this.getAttribute("data-city")),
            unescape(this.getAttribute("data-country")),
            unescape(this.getAttribute("data-openinghours")),
            unescape(this.getAttribute("data-distance"))
          )
            .then(function (t) {
              var n = _slicedToArray(t, 5),
                a = n[0],
                r = n[1],
                o = n[2],
                i = n[3],
                c = n[4];
              e.initSelectedParcelPoint();
              var s = document.querySelector(".VINW-parcel-name");
              var inp = document.querySelector("#point_relais");
              s.innerHTML = a;
              inp.value = a;
              e.closeMap();

              var currentRelayPoint = document.getElementById("point_relais");
              if (currentRelayPoint.value != "") {
                document.getElementById("place_order").disabled = false;
              }
            })
            ["catch"](function (t) {
              e.showError(t);
            });
        });
    },
    openMap: function () {
      this.mapContainer.classList.add("VINW-modal-show");
      var e =
        window.pageYOffset +
        (window.innerHeight - this.mapContainer.offsetHeight) / 2;
      e < window.pageYOffset && (e = window.pageYOffset),
        (this.mapContainer.style.top = e + "px"),
        this.map.resize();
    },
    closeMap: function () {
      this.mapContainer.classList.remove("VINW-modal-show"),
        this.clearMarkers();
    },
    initSelectedParcelPoint: function () {
      var e = document.querySelector(".VINW-parcel-client");
      e.innerHTML = translations.text.selectedParcelPoint + " ";
      var t = document.createElement("span");
      t.setAttribute("class", "VINW-parcel-name"), e.appendChild(t);
    },
    formatDistance: function (e) {
      var t = null;
      return (
        null !== e &&
          ((e = Math.round(e / 100) / 10),
          isNaN(e) ||
            (t = " (" + translations.text.kmaway.replace("%s", e) + ")")),
        t
      );
    },
    getParcelPoingAddress: function (e, t, n, a) {
      var r = [
        e,
        [n, t]
          .filter(function (e) {
            return null !== e;
          })
          .join(", "),
      ].join(" ");
      return null !== (a = this.formatDistance(a)) && (r += " " + a), r;
    },
    getPoints: function () {
      var e = this;
      e.getParcelPoints()
        .then(function (t) {
          e.addParcelPointMarkers(t);
          e.fillParcelPointPanel(t);
          e.addRecipientMarker(t);
          setTimeout(() => {
            e.setMapBounds();
          }, 1000);
        })
        ["catch"](function (t) {
          e.showError(t);
        });
    },
    getParcelPoints: function () {
      var e = this;
      return new Promise(function (t, n) {
        var a = e.getSelectedCarrier();
        a || n(translations.error.carrierNotFound);

        let carrierName = document.querySelector(
          'input[type="radio"][name="offer[]"]:checked'
        ).dataset.name;

        var data = new FormData();
        data.append("street", jQuery("#billing_address_1").val());
        data.append("zipCode", jQuery("#billing_postcode").val());
        data.append("city", jQuery("#billing_city").val());

        function padTo2Digits(num) {
          return num.toString().padStart(2, "0");
        }

        function formatDate(date) {
          return [
            padTo2Digits(date.getDate()),
            padTo2Digits(date.getMonth() + 1),
            date.getFullYear(),
          ].join("/");
        }

        var dataChrono = new FormData();
        dataChrono.append("street", jQuery("#billing_address_1").val());
        dataChrono.append("zipCode", jQuery("#billing_postcode").val());
        dataChrono.append("city", jQuery("#billing_city").val());
        dataChrono.append("productCode", "86");
        dataChrono.append("shipmentDate", formatDate(new Date()));
        dataChrono.append("country", jQuery("#billing_country").val());

        var xhr = new XMLHttpRequest();
        xhr.withCredentials = true;

        xhr.addEventListener("readystatechange", function () {
          if (this.readyState === 4) {
            var e =
              "object" === _typeof(this.response) && null !== this.response
                ? this.response
                : JSON.parse(this.response);
            !1 === e.success ? n(e.data.message) : t(e);
          }
        });
        if (carrierName == "ups") {
          xhr.open(
            "POST",
            baseurl +
              "/wp-content/plugins/HillebrandGoriEshipping/HillebrandGoriEshipping/HillebrandGoriEshippingPhp/getRelayPoints.php"
          );
          xhr.send(data);
        } else {
          xhr.open(
            "POST",
            baseurl +
              "/wp-content/plugins/HillebrandGoriEshipping/HillebrandGoriEshipping/HillebrandGoriEshippingPhp/getChronoRelayPoints.php"
          );
          xhr.send(dataChrono);
        }
      });
    },
    addParcelPointMarkers: function (e) {
      for (var i = 0; i < e.length; i++)
        (e[i].index = i), this.addParcelPointMarker(e[i], i);
    },
    fillSpaces: function (e, t) {
      for (; e.length < t; ) e += " ";
      return e;
    },
    formatOpeningDays: function (e) {
      for (var t = [], n = this.fillSpaces("", 11), a = 0; a < e.length; a++) {
        var r = e[a];
        if (r.weekday) {
          for (
            var o = r.weekday[0] + " ", i = r.openingPeriods, c = [], s = 0;
            s < i.length;
            s++
          ) {
            var l = i[s],
              p = l.openingTime === undefined ? "" : l.openingTime,
              d = l.closingTime === undefined ? "" : l.closingTime;
            "" !== p && "" !== d ? c.push(p + "-" + d) : c.push(n);
          }
          (o += c.join(" ")),
            a % 2 == 1 &&
              (o = '<span style="background-color: #d8d8d8;">' + o + "</span>"),
            t.push(o);
        }
      }
      return (
        '<pre class="VINW-parcel-point-schedule">' + t.join("\n") + "</pre>"
      );
    },
    generateParcelPointTagData: function (parcelPoint) {
      return (
        ' data-code="' +
        parcelPoint.id +
        '" data-name="' +
        escape(parcelPoint.name) +
        '" data-network="' +
        parcelPoint.addLine1 +
        '" data-zipcode="' +
        escape(parcelPoint.zipCode) +
        '" data-country="' +
        escape(parcelPoint.country) +
        '" data-city="' +
        escape(parcelPoint.city) +
        '" data-street="' +
        escape(parcelPoint.addLine1) +
        '"'
      );
    },
    addParcelPointMarker: function (parcelAdress, index) {
      let queryString = `${parcelAdress.addLine1} ${parcelAdress.name} ${parcelAdress.city} ${parcelAdress.postal}`;
      var requestOptions = {
        method: "GET",
        redirect: "follow",
      };

      fetch(
        `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURI(
          queryString
        )}.json?access_token=${APIkey}&country=FR`,
        requestOptions
      )
        .then((response) => response.json())
        .then((result) => {
          if (result.features[0] && result.features[0].relevance > 0.5) {
            var t =
              "<div class='VINW-marker-popup'><b>" +
              parcelAdress.name +
              '</b><br/><a href="#" class="VINW-parcel-point-button" ' +
              this.generateParcelPointTagData(parcelAdress) +
              "><b>" +
              translations.text.chooseParcelPoint +
              "</b></a><br/>" +
              parcelAdress.addLine1 +
              ", " +
              parcelAdress.zip_code +
              " " +
              parcelAdress.city +
              "<br/>";
            var n = this.getMarkerHtmlElement(index + 1),
              a = new mapboxgl.Popup({
                offset: 25,
              }).setHTML(t),
              r = new mapboxgl.Marker({
                element: n,
                anchor: "bottom",
              })
                .setLngLat(
                  new mapboxgl.LngLat(
                    parseFloat(result.features[0].geometry.coordinates[0]),
                    parseFloat(result.features[0].geometry.coordinates[1])
                  )
                )
                .setPopup(a)
                .addTo(this.map);
            this.markers.push(r),
              this.addRightColMarkerEvent(r, parcelAdress.id);
          }
        })
        .catch((error) => console.log("error", error));
    },
    addRightColMarkerEvent: function (e, t) {
      this.on("body", "click", ".VINW-show-info-" + t, function () {
        e.togglePopup();
      });
    },
    formatHours: function (e) {
      var t = e.split(":");
      return 3 === t.length && (e = t[0] + ":" + t[1]), e;
    },
    // adding the client's address between parcel points
    addRecipientMarker: function (e) {
      let queryString = `${jQuery("#streetinput").val()} ${jQuery(
        "#calc_shipping_city"
      ).val()} ${jQuery("#calc_shipping_postcode").val()}`;
      var requestOptions = {
        method: "GET",
        redirect: "follow",
      };

      fetch(
        `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURI(
          queryString
        )}.json?access_token=${APIkey}&country=FR`,
        requestOptions
      )
        .then((response) => response.json())
        .then((result) => {
          if (result.features[0] && result.features[0].relevance > 0.5) {
            var t = document.createElement("div");
            t.className = "VINW-marker-recipient";
            var n = new mapboxgl.Marker({
              element: t,
              anchor: "bottom",
            })
              .setLngLat(
                new mapboxgl.LngLat(
                  parseFloat(result.features[0].geometry.coordinates[0]),
                  parseFloat(result.features[0].geometry.coordinates[1])
                )
              )
              .addTo(this.map);
            this.markers.push(n);
          }
        })
        .catch((error) => console.log("error", error));
    },
    setMapBounds: function () {
      for (
        var e = new mapboxgl.LngLatBounds(), t = 0;
        t < this.markers.length;
        t++
      ) {
        var n = this.markers[t];
        e = e.extend(n.getLngLat());
      }
      this.map.fitBounds(e, {
        padding: 30,
        linear: !0,
      });
    },
    fillParcelPointPanel: function (e) {
      var t = "";
      t += "<table><tbody>";
      for (var n = 0; n < e.length; n++) {
        var a = e[n],
          r = null;
        (t += "<tr>"),
          (t += "<td>" + this.getMarkerHtmlElement(n + 1).outerHTML),
          (t +=
            '<div class="VINW-parcel-point-title"><a class="VINW-show-info-' +
            a.id +
            '">' +
            a.name +
            "</a></div><br/>"),
          (t += a.addLine1 + "<br/>"),
          (t += a.zipCode + " " + a.city + (null !== r ? r : "") + "<br/>"),
          (t +=
            '<a class="VINW-parcel-point-button" ' +
            this.generateParcelPointTagData(a) +
            "><b>" +
            translations.text.chooseParcelPoint +
            "</b></a>"),
          (t += "</td>"),
          (t += "</tr>");
      }
      (t += "</tbody></table>"),
        (document.querySelector("#VINW-pp-container").innerHTML = t);
    },
    getMarkerHtmlElement: function (e) {
      var t = document.createElement("div");
      return (t.className = "VINW-marker"), (t.innerHTML = e), t;
    },
    selectPoint: function (e, t, n, a, r, o, i, c, s) {
      var l = this;
      return new Promise(function (p, d) {
        var u = l.getSelectedCarrier();
        u || d(translations.error.carrierNotFound);
        var m = new XMLHttpRequest();
        (m.onreadystatechange = function () {
          if (4 === m.readyState) {
            var e =
              "object" === _typeof(m.response) && null !== m.response
                ? m.response
                : JSON.parse(m.response);
            !1 === e.success ? d(e.data.message) : p([t, a, r, o, s]);
          }
        }),
          m.open("POST", ajaxurl),
          m.setRequestHeader(
            "Content-Type",
            "application/x-www-form-urlencoded"
          ),
          (m.responseType = "json"),
          m.send(
            "action=VINW_set_point&carrier=" +
              encodeURIComponent(u) +
              "&code=" +
              encodeURIComponent(e) +
              "&name=" +
              encodeURIComponent(t) +
              "&address=" +
              encodeURIComponent(a) +
              "&zip_code=" +
              encodeURIComponent(r) +
              "&city=" +
              encodeURIComponent(o) +
              "&country=" +
              encodeURIComponent(i) +
              "&network=" +
              encodeURIComponent(n)
          );
      });
    },
    clearMarkers: function () {
      for (var e = 0; e < this.markers.length; e++) this.markers[e].remove();
      this.markers = [];
    },
    getSelectedCarrier: function () {
      var e = void 0,
        t = document.querySelector('input[type="hidden"].shipping_method');
      t
        ? (e = t.getAttribute("value"))
        : (e = document
            .querySelector("input.shipping_method:checked")
            .getAttribute("value"));
      return e;
    },
    showError: function (e) {
      console.log(e);
    },
    on: function (e, t, n, a) {
      var r = document.querySelector(e);
      r.addEventListener(t, function (e) {
        for (
          var t = r.querySelectorAll(n), o = e.target, i = 0, c = t.length;
          i < c;
          i++
        )
          for (var s = o, l = t[i]; s && s !== r; ) {
            if (s === l) return a.call(l, e);
            s = s.parentNode;
          }
      });
    },
  }),
    document.addEventListener("DOMContentLoaded", function () {
      e.parcelPointLinks.init();
      if (jQuery("#exp-details").length !== 0) {
        if (jQuery("#exp-details").val().split(";")["4"] !== "pointRelais") {
          jQuery("#relayaction").hide();
        }
      }
    });
})();
